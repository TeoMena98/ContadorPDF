<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Estad√≠sticas de Cotizaciones</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        body {
            background: #0d1117;
            color: #ffffff;
        }

        .card {
            border-radius: 12px;
        }

        .select2-container--default .select2-selection--multiple {
            min-height: 38px;
            padding: 4px 8px;
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            background-color: #ffffff;
            display: flex;
            align-items: center;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #ffc107;
            border: none;
            color: #000;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 6px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: #000;
            margin-right: 4px;
        }

        .select2-dropdown {
            background-color: #212529;
            color: #fff;
        }
    </style>


</head>

<body>
    <div class="container py-5">

        <h1 class="text-center mb-4">üìä Estad√≠sticas de Cotizaciones por Usuario</h1>

        <!-- FORMULARIO -->
        <div class="card bg-secondary p-4 shadow-lg mb-4">
            <div class="row g-3">
                <!-- TIPO DE FILTRO -->
                <div class="col-md-2">
                    <label class="form-label">Buscar por</label>
                    <select id="tipoBusqueda" class="form-select">
                        <option value="usuario">Usuario</option>
                        <option value="destino">Destino</option>
                    </select>
                </div>

                <!-- USUARIOS -->
                <div class="col-md-4">
                    <label class="form-label" id="labelBusqueda">Usuarios</label>
                    <select id="busqueda" class="form-select" multiple></select>
                    <div class="form-text text-light">
                        Puedes buscar y seleccionar varios
                    </div>
                </div>




                <!-- FILTRO -->
                <div class="col-md-2">
                    <label class="form-label">Filtro de fecha</label>
                    <select id="filtro" class="form-select">
                        <option value="hoy">Hoy</option>
                        <option value="ayer">Ayer</option>
                        <option value="semana">Esta semana</option>
                        <option value="semana_pasada">Semana pasada</option>
                        <option value="mes">Este mes</option>
                        <option value="personalizado">Personalizado</option>
                    </select>

                </div>

                <!-- FECHAS -->
                <div class="col-md-2">
                    <label class="form-label">Desde</label>
                    <input type="date" id="desde" class="form-control" disabled />
                </div>

                <div class="col-md-2">
                    <label class="form-label">Hasta</label>
                    <input type="date" id="hasta" class="form-control" disabled />
                </div>

                <!-- BOT√ìN -->



            </div>
            <div class="col-md-12 d-flex flex-column">
                <label class="form-label invisible">Acci√≥n</label>
                <button id="btnBuscar" class="btn btn-warning w-100">
                    Consultar estad√≠sticas
                </button>
            </div>
        </div>

        <!-- RESULTADOS -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Ordenar resultados</label>
                <select id="orden" class="form-select">
                    <option value="total_desc">Total cotizaciones (Mayor a menor)</option>
                    <option value="total_asc">Total cotizaciones (Menor a mayor)</option>
                    <option value="nombre_asc">Nombre (A ‚Üí Z)</option>
                    <option value="nombre_desc">Nombre (Z ‚Üí A)</option>
                </select>
            </div>
        </div>

        <div id="resultados"></div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let datosGlobales = [];
        const USUARIOS = [
            "carolina", "marly", "ana", "alex", "andres", "camilo.r", "aleja.u", "juan.h",
            "jefferson.c", "shara.c", "laura.c", "manuela.f", "mariadelmar.s", "juan.r",
            "johanna.c", "manuela.s", "leandro.b", "jennifer.h", "catalina.g", "juliana.v",
            "melissa.u", "angelica.p", "joha.g", "joan.o", "manuel.f", "cristian.m",
            "alexandra.c", "erika.v", "camila.m", "ingrid.p", "ana.a", "manuela.j",
            "yurany.g", "mariana.q"
        ];

        $(document).ready(function () {
            $("#busqueda").select2({ width: "100%" });
            $("#busqueda").prop("disabled", false);
            cargarUsuarios();
        });


        function cargarUsuarios() {
            $("#busqueda").empty();
            USUARIOS.forEach(u => {
                const option = new Option(u, u, false, false);
                $("#busqueda").append(option);
            });
        }

        const tipoBusqueda = document.getElementById("tipoBusqueda");
        const labelBusqueda = document.getElementById("labelBusqueda");

        tipoBusqueda.addEventListener("change", async () => {
            const tipo = tipoBusqueda.value;

            if (tipo === "usuario") {
                labelBusqueda.innerText = "Usuarios";
                $("#busqueda").prop("disabled", false);   // habilitar
                cargarUsuarios();
            }

            if (tipo === "destino") {
                labelBusqueda.innerText = "Destinos";

                // Deshabilitar select
                $("#busqueda").prop("disabled", true);

                // Limpiar selecci√≥n (no hace falta usarla)
                $("#busqueda").empty();

                // Opcional: mostrar texto informativo


                $("#busqueda").trigger("change");
            }
        });



        const filtroSelect = document.getElementById("filtro");
        const desdeInput = document.getElementById("desde");
        const hastaInput = document.getElementById("hasta");
        const resultados = document.getElementById("resultados");

        filtroSelect.addEventListener("change", () => {
            const personalizado = filtroSelect.value === "personalizado";
            desdeInput.disabled = !personalizado;
            hastaInput.disabled = !personalizado;
        });

        document.getElementById("btnBuscar").addEventListener("click", async () => {
            const filtro = filtroSelect.value;
            const desde = desdeInput.value;
            const hasta = hastaInput.value;
            const busqueda = $("#busqueda").val();
            const tipoBusqueda = document.getElementById("tipoBusqueda").value;

            resultados.innerHTML = `
    <div class="text-center mt-4">
      <div class="spinner-border text-warning"></div>
      <p class="mt-2">Consultando estad√≠sticas...</p>
    </div>
  `;

            try {
                const body = { filtro, tipoBusqueda };

                if (tipoBusqueda === "usuario") {
                    body.busqueda = busqueda;
                }

                if (filtro === "personalizado") {
                    if (!desde || !hasta) {
                        alert("Debes seleccionar fecha desde y hasta");
                        return;
                    }
                    body.desde = desde;
                    body.hasta = hasta;
                }

                const res = await fetch("/api/cotizaciones", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (!data.resultados || data.resultados.length === 0) {
                    resultados.innerHTML = `
            <div class="alert alert-danger text-center">
                No se encontraron cotizaciones en este rango.
            </div>
        `;
                    return;
                }

                // Guardamos los datos globales
                datosGlobales = data.resultados;

                // Renderizamos tabla seg√∫n el orden seleccionado
                renderTabla();

            } catch (error) {
                resultados.innerHTML = `
        <div class="alert alert-danger">
            Error consultando API: ${error.message}
        </div>
    `;
            }




        });
        function renderTabla() {
            const orden = document.getElementById("orden").value;
            const tipoBusqueda = document.getElementById("tipoBusqueda").value;

            let resultadosOrdenados = [...datosGlobales];

            if (orden === "total_desc") resultadosOrdenados.sort((a, b) => b.total - a.total);
            if (orden === "total_asc") resultadosOrdenados.sort((a, b) => a.total - b.total);
            if (orden === "nombre_asc") resultadosOrdenados.sort((a, b) => a.usuario.localeCompare(b.usuario));
            if (orden === "nombre_desc") resultadosOrdenados.sort((a, b) => b.usuario.localeCompare(a.usuario));

            const nombreColumna = tipoBusqueda === "destino" ? "Destino" : "Usuario";

            let html = `
      <div class="card bg-secondary p-4 shadow">
        <h4 class="mb-3">Resultados</h4>
        <table class="table table-dark table-striped table-bordered">
          <thead>
            <tr>
              <th>${nombreColumna}</th>
              <th>Total cotizaciones</th>
            </tr>
          </thead>
          <tbody>
    `;

            resultadosOrdenados.forEach(row => {
                html += `
            <tr>
              <td>${row.usuario}</td>
              <td class="text-center fw-bold">${row.total}</td>
            </tr>
        `;
            });

            html += `
          </tbody>
        </table>
      </div>
    `;

            resultados.innerHTML = html;
        }
        document.getElementById("orden").addEventListener("change", renderTabla);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


</body>

</html>
